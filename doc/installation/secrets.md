# Secrets

GitLab requires a variety of secrets to operate:

Gitlab Components:
* Registry authentication certificates
* SSH Host Keys and Certificates for GitLab Shell
* Passwords for individual Gitlab services

Optional External Services
* SMTP server
* LDAP
* Omniauth
* IMAP for incoming emails (via mail_room service)


Any secret not provided manually will be automatically generated with a random value. Automatic generation of HTTPS certificates is provided by Let's Encrypt.

To utilize autogenerated secrets continue to [next steps](#next-steps).

To specify your own secrets, proceed to [manual secret creation](#manual-secret-creation).

## Manual secret creation (optional)

Use `gitlab` as the release name if you followed previous steps in this
documentation.

- [TLS certificates](tls.md)
- [Registry authentication certificates](#registry-authentication-certificates)
- [SSH Host Keys](#ssh-host-keys)
- [Passwords](#passwords)
  * [Initial root password](#initial-root-password)
  * [Redis password](#redis-password)
  * [GitLab Shell secret](#gitlab-shell-secret)
  * [Gitaly secret](#gitaly-secret)
  * [GitLab Rails secret](#gitlab-rails-secret)
  * [GitLab workhorse secret](#gitlab-workhorse-secret)
  * [GitLab runner secret](#gitlab-runner-secret)
  * [Postgres password](#postgres-password)
  * [Minio secret](#minio-secret)
  * [Registry HTTP secret](#registry-http-secret)
- [External Services](#external-services)
  * [Unicorn Omniauth](#unicorn-omniauth)
  * [LDAP Password](#ldap-password)
  * [SMTP Password](#smtp-password)
  * [IMAP Password](#imap-password-for-incoming-emails)

### Registry authentication certificates

Communication between GitLab and Registry happens behind an Ingress so it is sufficient in most cases to use self-signed certificates
for this communication. If this traffic is exposed over a network, you
should generate publicly valid certificates.

In the example below, we assume that we require self-signed certificates.

Generate a certificate-key pair:

```
mkdir -p certs
openssl req -new -newkey rsa:4096 -subj "/CN=gitlab-issuer" -nodes -x509 -keyout certs/registry-example-com.key -out certs/registry-example-com.crt
```

Create a secret containing these certificates.
We will create `registry-auth.key` and `registry-auth.crt` keys inside the
`<name>-registry-secret` secret. Replace `<name>` with the name of the release.

```
kubectl create secret generic <name>-registry-secret --from-file=registry-auth.key=certs/registry-example-com.key --from-file=registry-auth.crt=certs/registry-example-com.crt
```

This secret is referenced by the `global.registry.certificate.secret` setting.

### SSH Host Keys

Generate the OpenSSH certificate-key pairs:

```
mkdir -p hostKeys
ssh-keygen -t rsa  -f hostKeys/ssh_host_rsa_key -N ""
ssh-keygen -t dsa  -f hostKeys/ssh_host_dsa_key -N ""
ssh-keygen -t ecdsa  -f hostKeys/ssh_host_ecdsa_key -N ""
ssh-keygen -t ed25519  -f hostKeys/ssh_host_ed25519_key -N ""
```

Create the secret containing these certificates. Replace `<name>` with the name
of the release.

```
kubectl create secret generic <name>-gitlab-shell-host-keys --from-file hostKeys
```

This secret is referenced by the `global.shell.hostKeys.secret` setting.

### Initial root password

Create a kubernetes secret for storing the initial root password. The password
should be at least 6 characters long. Replace `<name>` with the name of the
release.

```
kubectl create secret generic <name>-gitlab-initial-root-password --from-literal=password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 32)
```

### Redis password

Generate a random 64 character alpha-numeric password for Redis. Replace
`<name>` with the name of the release.

```
kubectl create secret generic <name>-redis-secret --from-literal=secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

### GitLab Shell secret

Generate a random 64 character alpha-numeric secret for GitLab Shell. Replace
`<name>` with the name of the release.

```
kubectl create secret generic <name>-gitlab-shell-secret --from-literal=secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

This secret is referenced by the `global.shell.authToken.secret` setting.

### Gitaly secret

Generate a random 64 character alpha-numeric token for Gitaly. Replace `<name>`
with the name of the release.

```
kubectl create secret generic <name>-gitaly-secret --from-literal=token=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

This secret is referenced by the `global.gitaly.authToken.secret` setting.

### GitLab Rails secret

Replace `<name>` with the name of the release.

```
cat << EOF > secrets.yml
production:
  secret_key_base: $(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 128)
  otp_key_base: $(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 128)
  db_key_base: $(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 128)
  openid_connect_signing_key: |
$(openssl genrsa 2048 | awk '{print "    " $0}')
EOF

kubectl create secret generic <name>-rails-secret --from-file=secrets.yml
```

This secret is referenced by the `global.railsSecrets.secret` setting.

### GitLab workhorse secret

Generate the workhorse secret. This must have a length of 32 characters and
base64-encoded. Replace `<name>` with the name of the release.

```
kubectl create secret generic <name>-gitlab-workhorse-secret --from-literal=shared_secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 32 | base64)
```

This secret is referenced by the `global.workhorse.key` setting.

### GitLab runner secret

Replace `<name>` with the name of the release.

```
kubectl create secret generic <name>-gitlab-runner-secret --from-literal=runner-registration-token=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

### Minio secret

Generate a set of random 20 & 64 character alpha-numeric keys for Minio.
Replace `<name>` with the name of the release.

```
kubectl create secret generic <name>-minio-secret --from-literal=accesskey=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 20) --from-literal=secretkey=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

This secret is referenced by the `global.minio.credentials.secret` setting.

### Postgresql password

Generate a random 64 character alpha-numeric password. Replace `<name>` with
the name of the release.

```
kubectl create secret generic <name>-postgresql-password --from-literal=postgres-password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

### Registry HTTP secret

Generate a random 64 character alpha-numeric key shared by all registry pods.
Replace `<name>` with the name of the release.

```
kubectl create secret generic <name>-registry-httpsecret --from-literal=secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64 | base64)
```

## External services

Some charts have further secrets to enable functionality that can not be automatically generated.

### Unicorn Omniauth

In order to enable the use of [Omniauth Providers](https://docs.gitlab.com/ee/integration/omniauth.html) with the deployed GitLab, please follow the [instructions in the Unicorn chart](../charts/gitlab/unicorn/index.md#omniauth.providers)

### LDAP Password

If you need password authentication to connect with your LDAP server, you must store the password in a Kubernetes secret.

```
kubectl create secret generic ldap-main-password --from-literal=password=yourpasswordhere
```

Then use `--set global.appConfig.ldap.servers.main.password.secret=ldap-main-password` to 
inject the password into your configuration.

### SMTP password

If you are using an SMTP server that requires authentication, store the password
in a Kubernetes secret.

```
kubectl create secret generic smtp-password --from-literal=password=yourpasswordhere
```

Then use `--set global.smtp.password.secret=smtp-password` in your helm command.

### IMAP password for incoming emails

To let GitLab have access to [incoming emails](https://docs.gitlab.com/ee/administration/incoming_email.html)
store the password of the IMAP account in a Kubernetes secret.

```
kubectl create secret generic incoming-email-password --from-literal=password=yourpasswordhere
```

Then use `--set global.appConfig.incomingEmail.password.secret=incoming-email-password`
in your helm command along with other required settings as specified [in the docs](command-line-options.md#incoming-email-configuration).

## Next steps

Once all secrets have been generated and stored, you can proceed [deploying GitLab](deployment.md).
