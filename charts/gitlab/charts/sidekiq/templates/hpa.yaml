{{- if .Values.enabled -}}
{{- $name := default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- $releaseName := .Release.Name -}}
{{- $fullname := printf "%s-%s" $releaseName $name | trunc 63 | trimSuffix "-" -}}
{{- range .Values.pods -}}
{{- $queueName := printf "%s-%s" $fullname .name | trunc 63 }}
{{- $hpa := default dict .hpa }}
{{- $podCommonLabels := .podLabels }}
{{- if hasKey .common "labels" }}
{{- $podCommonLabels = default (dict) .common.labels }}
{{- end }}
{{- $commonPodLabels := include "sidekiq.commonPodLabels" (dict "commonLabels" $podCommonLabels "podLabels" .podLabels) | nindent 4 -}}
---
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: {{ printf "%s-v1" ($queueName | trunc 60) }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "gitlab.standardLabels" $ | nindent 4 }}
    {{- include "gitlab.commonLabels" $ | nindent 4 }}
    {{- $commonPodLabels }}
    queue_pod_name: {{ .name }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ printf "%s-v1" ($queueName | trunc 60) }}
  minReplicas: {{ default $.Values.minReplicas .minReplicas }}
  maxReplicas: {{ default $.Values.maxReplicas .maxReplicas }}
  metrics:
  - type: Resource
    resource:
      name: cpu
      targetAverageValue: {{ default $.Values.hpa.targetAverageValue $hpa.targetAverageValue }}
# Leave this here - This line denotes end of block to the parser.
---
{{- end }}
{{- end -}}
